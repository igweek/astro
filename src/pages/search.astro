---
import Layout from "../layouts/main.astro";
import PageHeading from "../components/page-heading.astro";
import { getCollection } from "astro:content";

const posts = await getCollection("post");

// 处理数据为前端可用的格式
const processedPosts = posts.map(post => ({
    title: post.data.title,
    url: `/post/${post.slug}`,
    content: post.body,
    date: post.data.dateFormatted,
    description: post.data.description
}));
---

<Layout title="Search Posts">
  <main class="relative flex-1 flex flex-col">
    <section class="relative z-20 w-full max-w-2xl mx-auto px-7 lg:px-0 py-12 flex-1 flex flex-col">
      <PageHeading
        title="Search Posts"
        description="搜索文章内容，探索你感兴趣的主题。"
      />

      <div class="w-full max-w-2xl mx-auto mb-8">
        <input 
          type="text" 
          id="searchInput" 
          placeholder="输入关键词搜索..." 
          class="block w-full px-4 py-3 bg-white dark:bg-neutral-950 border border-dashed border-neutral-300 dark:border-neutral-600 rounded-2xl focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-500 transition-all duration-200"
          style="width: 100%; max-width: 100%;"
        />
      </div>

      <div id="searchResults" class="w-full max-w-2xl mx-auto z-50 flex flex-col items-stretch gap-5 flex-1">
        <!-- 搜索结果将在这里动态显示 -->
      </div>
    </section>
  </main>
</Layout>

<script is:inline define:vars={{ processedPosts }}>
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    
    // 使用已处理的文章数据
    const allPosts = processedPosts;

    function performSearch(searchTerm) {
        if (!searchTerm) {
            searchResults.innerHTML = '';
            return;
        }

        const results = allPosts.filter(post => 
            post.title?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            post.content?.toLowerCase().includes(searchTerm.toLowerCase())
        );

        searchResults.innerHTML = results.length ? results.map(post => `
            <div
                class="relative border border-transparent border-dashed cursor-pointer p-7 group rounded-2xl"
                onclick="location.href='${post.url}'"
            >
                <div class="absolute inset-0 z-20 w-full h-full duration-300 ease-out bg-white border border-dashed dark:bg-neutral-950 rounded-2xl border-neutral-300 dark:border-neutral-600 group-hover:-translate-x-1 group-hover:-translate-y-1"></div>
                <div class="absolute inset-0 z-10 w-full h-full duration-300 ease-out border border-dashed rounded-2xl border-neutral-300 dark:border-neutral-600 group-hover:translate-x-1 group-hover:translate-y-1"></div>
                <div class="relative z-30 duration-300 ease-out group-hover:-translate-x-1 group-hover:-translate-y-1">
                    <h2 class="flex items-center mb-3">
                        <a href="${post.url}" class="text-base font-bold leading-tight tracking-tight sm:text-lg dark:text-neutral-100">
                            ${post.title}
                        </a>
                        <svg class="group-hover:translate-x-0 flex-shrink-0 translate-y-0.5 -translate-x-1 w-2.5 h-2.5 stroke-current ml-1 transition-all ease-in-out duration-200 transform" viewBox="0 0 13 15">
                            <path d="M1.08975 7.93502L10.8897 7.93502M10.8897 7.93502L6.78378 3.82904M10.8897 7.93502L6.78378 12.041" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                    </h2>
                    <p class="text-sm text-neutral-600 dark:text-neutral-400">
                        <span>${post.description}</span>
                    </p>
                    <div class="mt-2.5 text-xs font-medium text-neutral-800 dark:text-neutral-300">
                        Posted on ${post.date}
                    </div>
                </div>
            </div>
        `).join('') : '<p class="text-neutral-500 dark:text-neutral-400 text-center py-8">没有找到相关文章</p>';
    }

    // 添加输入事件监听
    searchInput.addEventListener('input', (e) => {
        performSearch(e.target.value.trim());
    });
</script>
